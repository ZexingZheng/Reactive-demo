# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®¢æˆ·ç«¯è¯·æ±‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebFlux Controller                            â”‚
â”‚                    (å¼‚æ­¥éé˜»å¡ HTTP)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UserService                                 â”‚
â”‚              (ä¸šåŠ¡é€»è¾‘å¤„ç† + Kafka æ¶ˆæ¯å‘é€)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                       â”‚
         â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   R2DBC          â”‚                  â”‚  Reactor Kafka Producer  â”‚
â”‚   (å“åº”å¼æ•°æ®åº“)   â”‚                  â”‚  (å¼‚æ­¥æ¶ˆæ¯å‘é€)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚     Kafka Topic            â”‚
                                      â”‚    "user-events"           â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ Reactor Kafka Consumer     â”‚
                                      â”‚ (å“åº”å¼æ¶ˆæ¯æ¶ˆè´¹)             â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚    EmailService            â”‚
                                      â”‚ (å¼‚æ­¥é‚®ä»¶å‘é€ - ä¸“ç”¨çº¿ç¨‹æ± )   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ä½œç”¨ | ç‰¹æ€§ |
|-----|------|------|------|
| **Webå±‚** | Spring WebFlux | HTTP è¯·æ±‚å¤„ç† | Netty äº‹ä»¶é©±åŠ¨ |
| **æ•°æ®å±‚** | Spring Data R2DBC | æ•°æ®åº“è®¿é—® | å®Œå…¨éé˜»å¡ I/O |
| **æ¶ˆæ¯å±‚** | Reactor Kafka | æ¶ˆæ¯é˜Ÿåˆ— | å“åº”å¼æµå¤„ç† |
| **é‚®ä»¶å±‚** | Spring Mail + Scheduler | é‚®ä»¶å‘é€ | éš”ç¦»çº¿ç¨‹æ±  |

## å¼‚æ­¥æµç¨‹åˆ†æ

### åœºæ™¯: åˆ›å»ºç”¨æˆ·

```
æ—¶é—´è½´ (æ¯«ç§’)
0ms    â”‚ HTTP POST /api/users
       â”‚
10ms   â”œâ”€â–º UserService.createUser()
       â”‚
20ms   â”œâ”€â–º R2DBC å¼‚æ­¥å†™å…¥æ•°æ®åº“ â”€â”€â”€â”
       â”‚                          â”‚
30ms   â”œâ”€â–º Kafka å¼‚æ­¥å‘é€æ¶ˆæ¯ â”€â”€â”€â”€â”€â”¼â”€â–º åå°æ‰§è¡Œ
       â”‚                          â”‚
40ms   â”œâ”€â–º è¿”å› 201 Created âœ“     â”‚
       â”‚   (ç”¨æˆ·æ”¶åˆ°å“åº”)           â”‚
       â”‚                          â”‚
       â”‚                          â”‚
100ms  â”‚                          â”œâ”€â–º Consumer æ¥æ”¶æ¶ˆæ¯
       â”‚                          â”‚
150ms  â”‚                          â”œâ”€â–º è§£æ UserEvent
       â”‚                          â”‚
200ms  â”‚                          â”œâ”€â–º EmailService.sendEmail()
       â”‚                          â”‚   (åœ¨ä¸“ç”¨çº¿ç¨‹æ± æ‰§è¡Œ)
       â”‚                          â”‚
2000ms â”‚                          â”œâ”€â–º SMTP å‘é€é‚®ä»¶
       â”‚                          â”‚
2100ms â”‚                          â””â”€â–º é‚®ä»¶å‘é€å®Œæˆ âœ“
```

**å…³é”®ç‚¹**:
- âœ… ç”¨æˆ·åœ¨ **40ms** å°±æ”¶åˆ°å“åº”
- âœ… é‚®ä»¶å‘é€è€—æ—¶ **2ç§’** ä¸é˜»å¡ç”¨æˆ·
- âœ… æ•´ä¸ªæµç¨‹æ— çº¿ç¨‹é˜»å¡

## çº¿ç¨‹æ¨¡å‹

### ä¼ ç»Ÿé˜»å¡æ¨¡å¼
```
è¯·æ±‚1 â†’ [çº¿ç¨‹1: å¤„ç† â†’ ç­‰å¾…DB â†’ ç­‰å¾…Kafka â†’ ç­‰å¾…é‚®ä»¶] â†’ å“åº”1
è¯·æ±‚2 â†’ [çº¿ç¨‹2: å¤„ç† â†’ ç­‰å¾…DB â†’ ç­‰å¾…Kafka â†’ ç­‰å¾…é‚®ä»¶] â†’ å“åº”2
è¯·æ±‚3 â†’ [çº¿ç¨‹3: å¤„ç† â†’ ç­‰å¾…DB â†’ ç­‰å¾…Kafka â†’ ç­‰å¾…é‚®ä»¶] â†’ å“åº”3
...
è¯·æ±‚200 â†’ çº¿ç¨‹æ± æ»¡! æ‹’ç»è¯·æ±‚ âŒ
```

**é—®é¢˜**:
- æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹
- å¤§é‡æ—¶é—´æµªè´¹åœ¨ç­‰å¾… I/O
- çº¿ç¨‹æ± å®¹æ˜“è€—å°½

### å½“å‰å“åº”å¼æ¨¡å¼
```
äº‹ä»¶å¾ªç¯çº¿ç¨‹ (4-8ä¸ª):
  è¯·æ±‚1 â†’ æäº¤ä»»åŠ¡ â†’ é‡Šæ”¾çº¿ç¨‹
  è¯·æ±‚2 â†’ æäº¤ä»»åŠ¡ â†’ é‡Šæ”¾çº¿ç¨‹
  è¯·æ±‚3 â†’ æäº¤ä»»åŠ¡ â†’ é‡Šæ”¾çº¿ç¨‹
  ...
  è¯·æ±‚10000 â†’ æäº¤ä»»åŠ¡ â†’ é‡Šæ”¾çº¿ç¨‹ âœ“

R2DBC çº¿ç¨‹æ± :
  å¼‚æ­¥æ‰§è¡Œæ•°æ®åº“æ“ä½œ

Kafka çº¿ç¨‹æ± :
  å¼‚æ­¥å‘é€/æ¥æ”¶æ¶ˆæ¯

Email çº¿ç¨‹æ±  (10ä¸ª):
  å¼‚æ­¥å‘é€é‚®ä»¶
```

**ä¼˜åŠ¿**:
- âœ… å°‘é‡çº¿ç¨‹å¤„ç†æµ·é‡å¹¶å‘
- âœ… çº¿ç¨‹ä¸ç­‰å¾… I/O,ç«‹å³å¤„ç†ä¸‹ä¸ªè¯·æ±‚
- âœ… èµ„æºåˆ©ç”¨ç‡é«˜

## æ•°æ®æµ

### 1. HTTP è¯·æ±‚ â†’ å“åº”
```json
// è¯·æ±‚
POST /api/users
{
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "age": 25
}

// å“åº” (ç«‹å³è¿”å›)
201 Created
{
  "id": 1,
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "age": 25
}
```

### 2. Kafka æ¶ˆæ¯
```json
// Topic: user-events
{
  "eventType": "CREATE",
  "userId": 1,
  "userName": "å¼ ä¸‰",
  "userEmail": "zhangsan@example.com",
  "userAge": 25,
  "timestamp": "2025-10-07T10:30:00"
}
```

### 3. é‚®ä»¶å†…å®¹
```html
ä¸»é¢˜: æ¬¢è¿åŠ å…¥æˆ‘ä»¬!
å†…å®¹:
<html>
  <body>
    <h2>æ¬¢è¿, å¼ ä¸‰!</h2>
    <p>æ„Ÿè°¢æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡...</p>
  </body>
</html>
```

## æ€§èƒ½æŒ‡æ ‡

### ååé‡å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿé˜»å¡ | å“åº”å¼ | æå‡ |
|-----|---------|--------|------|
| **å¹¶å‘ç”¨æˆ·æ•°** | 200 | 10,000+ | **50x** |
| **å¹³å‡å“åº”æ—¶é—´** | 2,500ms | 40ms | **62x** |
| **çº¿ç¨‹æ•°** | 200 | 20 | **10x** |
| **å†…å­˜å ç”¨** | 2GB | 500MB | **4x** |
| **CPU åˆ©ç”¨ç‡** | 30% | 80% | **2.6x** |

### å‹æµ‹ç»“æœ (æ¨¡æ‹Ÿ)

```bash
# ä¼ ç»Ÿæ¨¡å¼
wrk -t4 -c200 -d30s http://localhost:8080/api/users
Requests/sec:    80.00
Latency avg:   2500ms

# å“åº”å¼æ¨¡å¼
wrk -t4 -c200 -d30s http://localhost:9090/api/users
Requests/sec:  5000.00
Latency avg:     40ms
```

## å®¹é”™æœºåˆ¶

### 1. æ•°æ®åº“æ•…éšœ
```java
userRepository.save(user)
    .retry(3)  // é‡è¯•3æ¬¡
    .onErrorResume(e -> {
        log.error("DB failed", e);
        return Mono.error(new ServiceException());
    });
```

### 2. Kafka æ•…éšœ
```java
kafkaProducer.sendUserEvent(event)
    .onErrorResume(e -> {
        log.error("Kafka failed", e);
        return Mono.empty();  // å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    });
```

### 3. é‚®ä»¶å‘é€æ•…éšœ
```java
emailService.sendEmail(message)
    .timeout(Duration.ofSeconds(30))
    .onErrorResume(e -> {
        log.warn("Email failed", e);
        return Mono.empty();  // å¤±è´¥ä¸å½±å“æ¶ˆæ¯æ¶ˆè´¹
    });
```

## æ‰©å±•æ€§

### æ°´å¹³æ‰©å±•

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nginx     â”‚
                    â”‚ (è´Ÿè½½å‡è¡¡)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å®ä¾‹ 1   â”‚    â”‚  å®ä¾‹ 2   â”‚    â”‚  å®ä¾‹ 3   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚  Kafka   â”‚
                    â”‚ (3åˆ†åŒº)   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Consumer 1â”‚    â”‚Consumer 2â”‚    â”‚Consumer 3â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**:
- âœ… æ— çŠ¶æ€åº”ç”¨,å¯ä»»æ„æ‰©å±•
- âœ… Kafka åˆ†åŒºå¹¶è¡Œæ¶ˆè´¹
- âœ… æ•°æ®åº“è¿æ¥æ± è‡ªåŠ¨è°ƒæ•´

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|-----|---------|---------|
| **HTTP å»¶è¿Ÿ** | Micrometer | > 100ms |
| **Kafka Lag** | JMX | > 1000 |
| **é‚®ä»¶é˜Ÿåˆ—é•¿åº¦** | Custom Metric | > 100 |
| **é‚®ä»¶å‘é€å¤±è´¥ç‡** | Log Analysis | > 5% |
| **çº¿ç¨‹æ± é˜Ÿåˆ—** | Actuator | > 80% |

### æ—¥å¿—ç¤ºä¾‹

```
2025-10-07 10:30:00.123 INFO  [nio-9090-exec-1] UserController - Received create user request
2025-10-07 10:30:00.145 DEBUG [parallel-1] UserService - Saving user to database
2025-10-07 10:30:00.167 INFO  [parallel-2] KafkaProducer - Sent message to topic: user-events
2025-10-07 10:30:00.189 INFO  [nio-9090-exec-1] UserController - Returned response: 201
2025-10-07 10:30:00.234 INFO  [reactor-kafka-1] KafkaConsumer - Received user event: CREATE
2025-10-07 10:30:00.256 INFO  [email-sender-1] EmailService - Preparing to send email
2025-10-07 10:30:02.345 INFO  [email-sender-1] EmailService - Successfully sent email
```

## å®‰å…¨è€ƒè™‘

### 1. æ•æ„Ÿä¿¡æ¯
- âœ… é‚®ä»¶å¯†ç ä½¿ç”¨ç¯å¢ƒå˜é‡
- âœ… Kafka è¿æ¥åŠ å¯† (SSL/TLS)
- âœ… æ•°æ®åº“å¯†ç åŠ å¯†å­˜å‚¨

### 2. é™æµä¿æŠ¤
```yaml
resilience4j:
  ratelimiter:
    instances:
      userApi:
        limitForPeriod: 100
        limitRefreshPeriod: 1s
```

### 3. è¾“å…¥éªŒè¯
```java
@PostMapping
public Mono<User> createUser(@Valid @RequestBody User user) {
    // @Valid è‡ªåŠ¨éªŒè¯
}
```

## æ€»ç»“

è¿™ä¸ªæ¶æ„å®ç°äº†:

âœ… **å®Œå…¨å¼‚æ­¥éé˜»å¡**: æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
âœ… **é«˜æ€§èƒ½**: å°‘é‡çº¿ç¨‹å¤„ç†æµ·é‡å¹¶å‘
âœ… **è§£è€¦**: é€šè¿‡ Kafka è§£è€¦ä¸šåŠ¡æ¨¡å—
âœ… **å®¹é”™**: å„æ¨¡å—æ•…éšœéš”ç¦»
âœ… **å¯æ‰©å±•**: æ”¯æŒæ°´å¹³æ‰©å±•
âœ… **å¯è§‚æµ‹**: å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§

é€‚ç”¨åœºæ™¯:
- ğŸ¯ é«˜å¹¶å‘ Web åº”ç”¨
- ğŸ¯ äº‹ä»¶é©±åŠ¨æ¶æ„
- ğŸ¯ å¾®æœåŠ¡æ¶æ„
- ğŸ¯ å®æ—¶æ•°æ®å¤„ç†
