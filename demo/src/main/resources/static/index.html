<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reactive CRUD Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    h1 { font-size: 24px; margin-bottom: 10px; }
    .row { display:flex; gap:20px; margin-bottom: 20px; }
    .col { flex:1; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f0f0f0; }
    input, button { padding:8px; font-size:14px; }
    #response { white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:10px; margin-top:10px; height:120px; overflow:auto; }
    .actions button { margin-right:6px; }
  </style>
</head>
<body>

  <h1>Reactive CRUD Demo</h1>
  <p>Simple demo to create/list/update/delete users. API base: <code>/api/users</code></p>

  <div class="row">
    <div class="col">
      <h3>Create user</h3>
      <form id="createForm" onsubmit="event.preventDefault(); createUser();">
        <div><input id="createName" placeholder="Name" required /></div>
        <div><input id="createEmail" placeholder="Email" type="email" required /></div>
        <div><input id="createAge" placeholder="Age" type="number" min="0" /></div>
        <div style="margin-top:8px;">
          <button type="submit">Create</button>
          <button type="button" onclick="getAllUsers()">Refresh</button>
        </div>
      </form>
    </div>

    <div class="col">
      <h3>Update user</h3>
      <form id="updateForm" onsubmit="event.preventDefault(); updateUser();">
        <div><input id="updateId" placeholder="User ID" required /></div>
        <div><input id="updateName" placeholder="Name" /></div>
        <div><input id="updateEmail" placeholder="Email" type="email" /></div>
        <div><input id="updateAge" placeholder="Age" type="number" min="0" /></div>
        <div style="margin-top:8px;">
          <button type="submit">Update</button>
          <button type="button" onclick="fillUpdateFromSelection()">Fill from selection</button>
        </div>
      </form>
    </div>
  </div>

  <h3>User list</h3>
  <table id="usersTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Email</th><th>Age</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="response"></div>

  <script>
    const API_BASE = '/api/users';

    async function getAllUsers() {
      try {
        const res = await fetch(API_BASE);
        const data = await res.json();
        renderUsers(data);
        showResponse(data, !res.ok);
      } catch (e) {
        showResponse(String(e), true);
      }
    }

    function renderUsers(users) {
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No users</td></tr>';
        return;
      }
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id ?? ''}</td>
          <td>${escapeHtml(u.name ?? '')}</td>
          <td>${escapeHtml(u.email ?? '')}</td>
          <td>${u.age ?? ''}</td>
          <td class="actions">
            <button onclick='startEdit(${JSON.stringify(u)})'>Edit</button>
            <button onclick='deleteUser("${u.id}")'>Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function startEdit(user) {
      document.getElementById('updateId').value = user.id || '';
      document.getElementById('updateName').value = user.name || '';
      document.getElementById('updateEmail').value = user.email || '';
      document.getElementById('updateAge').value = user.age ?? '';
      window.scrollTo(0,0);
    }

    function fillUpdateFromSelection() {
      // helper in case user copies ID manually; does nothing else
      const id = document.getElementById('updateId').value;
      if (!id) return;
      fetch(`${API_BASE}/${id}`)
        .then(r => r.json())
        .then(u => startEdit(u))
        .catch(e => showResponse(String(e), true));
    }

    async function createUser() {
      const name = document.getElementById('createName').value;
      const email = document.getElementById('createEmail').value;
      const age = document.getElementById('createAge').value;
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name, email, age: age ? Number(age) : null })
        });
        const data = await res.json();
        showResponse(data, !res.ok);
        if (res.ok) {
          document.getElementById('createForm').reset();
          getAllUsers();
        }
      } catch (e) {
        showResponse(String(e), true);
      }
    }

    async function updateUser() {
      const id = document.getElementById('updateId').value;
      if (!id) { showResponse('ID is required', true); return; }
      const name = document.getElementById('updateName').value;
      const email = document.getElementById('updateEmail').value;
      const age = document.getElementById('updateAge').value;
      try {
        const res = await fetch(`${API_BASE}/${id}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name, email, age: age ? Number(age) : null })
        });
        const data = await res.json();
        showResponse(data, !res.ok);
        if (res.ok) getAllUsers();
      } catch (e) {
        showResponse(String(e), true);
      }
    }

    async function deleteUser(id) {
      if (!confirm('Delete this user?')) return;
      try {
        const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
        if (res.status === 204 || res.ok) {
          showResponse('Deleted', false);
          getAllUsers();
        } else {
          const data = await res.json();
          showResponse(data, true);
        }
      } catch (e) {
        showResponse(String(e), true);
      }
    }

    function showResponse(data, isError=false) {
      const el = document.getElementById('response');
      try {
        el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        el.style.borderColor = isError ? '#f99' : '#e0e0e0';
      } catch (e) {
        el.textContent = String(data);
      }
    }

    // initial load
    getAllUsers();
  </script>
</body>
</html>
